<!DOCTYPE html>
<html>
<head>
  <title>Transfusion Data Dashboard</title>
  <meta charset="UTF-8">
  
  <!-- Chart.js - more reliable on CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { 
      background: white; 
      border-radius: 8px; 
      padding: 20px; 
      margin-bottom: 20px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    /* Tab Navigation Styles */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab-button {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      margin-right: 10px;
    }
    .tab-button:hover {
      color: #3b82f6;
    }
    .tab-button.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Table Styles */
    .stats-table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9em;
    }
    .stats-table th, .stats-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    /* Fixed column widths for alignment */
    .stats-table th:first-child, 
    .stats-table td:first-child {
      width: 50%;
    }
    .stats-table th:nth-child(2), 
    .stats-table td:nth-child(2) {
      width: 25%;
    }
    .stats-table th:nth-child(3), 
    .stats-table td:nth-child(3) {
      width: 25%;
    }
    .stats-table th {
      background-color: #f0f9ff;
      font-weight: 600;
    }
    .stats-table tr:last-child td {
      border-bottom: none;
    }
    .stats-table tr.total-row {
      border-top: 2px solid #ddd;
      font-weight: 600;
    }
    .stats-table tr.section-header {
      background-color: #f0f9ff;
      font-weight: 600;
    }
    .stats-table tr.italic td:first-child {
      font-style: italic;
    }
    .stats-table-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 10px;
      text-align: center;
    }
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .stats-column {
      flex: 1;
      min-width: 300px;
    }
    .header { text-align: center; margin-bottom: 20px; }
    .controls { margin-bottom: 20px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 300px; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-select, .form-input { 
      width: 100%; 
      padding: 8px; 
      border-radius: 4px; 
      border: 1px solid #ddd; 
    }
    .btn { 
      background: #3b82f6; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .btn:hover { background: #2563eb; }
    .btn-sm { padding: 4px 8px; font-size: 0.9em; }
    .chart-container { position: relative; height: 400px; width: 100%; }
    .tag { 
      display: inline-block; 
      padding: 4px 8px; 
      border-radius: 16px; 
      margin-right: 5px; 
      margin-bottom: 5px; 
      cursor: pointer; 
    }
    .tag.active { background: #3b82f6; color: white; }
    .tag:not(.active) { background: #e5e7eb; }
    .info { 
      padding: 10px; 
      background: #f0f9ff; 
      border-radius: 4px; 
      margin-bottom: 10px; 
    }
    .loading { 
      text-align: center; 
      padding: 50px; 
      font-size: 18px; 
      color: #666; 
    }
    .error { 
      background: #fee2e2; 
      color: #b91c1c; 
      padding: 15px; 
      border-radius: 6px; 
      margin-bottom: 20px; 
    }
    .debug-info { 
      font-family: monospace; 
      font-size: 12px; 
      background: #f8fafc; 
      padding: 10px; 
      border: 1px solid #e2e8f0; 
      border-radius: 4px; 
      margin-top: 10px; 
      white-space: pre-wrap; 
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">Loading Transfusion Dashboard...</div>
  <div id="app-container" class="container" style="display: none;"></div>

  <script>
    // Tab navigation functionality
    function openTab(evt, tabName) {
      // Hide all tab content
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      
      // Remove active class from all tab buttons
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      
      // Show the selected tab content and mark button as active
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }
    
    // Hide loading message when page is ready
    window.addEventListener('load', function() {
      setTimeout(function() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
      }, 500); 
    });

    // Main dashboard class
    class TransfusionDashboard {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        
        // State variables
        this.fileCase = 'unknown';    
        this.indexData = [];          
        this.vitalParams = [];        
        this.compFactors = [];        
        this.chartData = [];          
        this.selectedVital = '';      
        this.selectedCompFactor = ''; 
        this.comparisonValues = [];   
        this.selectedComparisons = [];

        // Start from transfusion time (0):
        this.timeRange = [0, 720];    

        this.showConfidenceInterval = true; 
        this.showBaseModel = false; 
        this.showDeltaPlot = true;   
        
        this.metaInfo = {             
          vitalName: '',
          compName: '',
          yLabel: '',
          DeltaYLabel: ''
        };
        this.currentFileName = '';    
        this.chart = null;            
        this.isInitialLoad = true;    
        this.debugMode = false;       
        
        // Keep track of previous vital & factor
        this.lastSelectedCompFactor = null;
        this.lastSelectedVital = null;
        
        // Initialize dashboard
        this.initialize();
      }
      
      // Initialize dashboard
      async initialize() {
        try {
          // Create UI structure
          this.createUI();
          
          // Load index data - wrap in try/catch so the rest of the UI still works
          try {
            await this.loadIndexData();
          } catch (loadError) {
            console.error('Data loading error:', loadError);
            this.showError(`Failed to load visualization data: ${loadError.message}. Descriptive Statistics tab is still available.`);
            // Make sure the loading indicator is hidden
            this.hideLoading();
            
            // No need to switch to the Descriptive Statistics tab since it's already active
            // The tab order has been reversed with Descriptive Statistics first and Visualization second
          }
          
        } catch (error) {
          console.error('Initialization error:', error);
          this.showError(`Failed to initialize dashboard: ${error.message}`);
        }
      }
      
      // Create the descriptive statistics content
      createDescriptiveStatsContent() {
        return `
          <div class="card">
            <div class="stats-container">
              <div class="stats-column">
                <div class="stats-table-title">Table 1a. Characteristics of Transfused Patients</div>
                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Patient Sex</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>Male</td>
                      <td>4,032</td>
                      <td>59.9%</td>
                    </tr>
                    <tr class="italic">
                      <td>Female</td>
                      <td>2,704</td>
                      <td>40.1%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Unique patients</td>
                      <td>6,736</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>
                
                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Patient Age</th>
                      <th colspan="2"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>Mean Age</td>
                      <td colspan="2">62</td>
                    </tr>
                    <tr class="italic">
                      <td>Median Age (IQR)</td>
                      <td colspan="2">66 (54 - 74)</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Patient Age Distribution</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>&lt; 20 years old</td>
                      <td>56</td>
                      <td>0.8%</td>
                    </tr>
                    <tr class="italic">
                      <td>20 - 29 years old</td>
                      <td>327</td>
                      <td>4.9%</td>
                    </tr>
                    <tr class="italic">
                      <td>30 - 39 years old</td>
                      <td>408</td>
                      <td>6.1%</td>
                    </tr>
                    <tr class="italic">
                      <td>40 - 49 years old</td>
                      <td>516</td>
                      <td>7.7%</td>
                    </tr>
                    <tr class="italic">
                      <td>50 - 59 years old</td>
                      <td>998</td>
                      <td>14.8%</td>
                    </tr>
                    <tr class="italic">
                      <td>60 - 69 years old</td>
                      <td>1,781</td>
                      <td>26.4%</td>
                    </tr>
                    <tr class="italic">
                      <td>70 - 79 years old</td>
                      <td>1,943</td>
                      <td>28.8%</td>
                    </tr>
                    <tr class="italic">
                      <td>&gt; 80 years old</td>
                      <td>707</td>
                      <td>10.5%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Unique patients</td>
                      <td>6,736</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>RBC units received</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>1 unit</td>
                      <td>3,807</td>
                      <td>56.5%</td>
                    </tr>
                    <tr class="italic">
                      <td>2 units</td>
                      <td>1,431</td>
                      <td>21.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>3 units</td>
                      <td>618</td>
                      <td>9.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>4 units</td>
                      <td>302</td>
                      <td>4.5%</td>
                    </tr>
                    <tr class="italic">
                      <td>5 units</td>
                      <td>172</td>
                      <td>2.6%</td>
                    </tr>
                    <tr class="italic">
                      <td>6 units</td>
                      <td>95</td>
                      <td>1.4%</td>
                    </tr>
                    <tr class="italic">
                      <td>7 units</td>
                      <td>81</td>
                      <td>1.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>8 units</td>
                      <td>37</td>
                      <td>0.5%</td>
                    </tr>
                    <tr class="italic">
                      <td>9 units</td>
                      <td>41</td>
                      <td>0.6%</td>
                    </tr>
                    <tr class="italic">
                      <td>&gt;9 units</td>
                      <td>152</td>
                      <td>2.3%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Unique patients</td>
                      <td>6,736</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="stats-column">
                <div class="stats-table-title">Table 1b. Characteristics of Transfused Blood Components</div>
                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Donor Hemoglobin (g/L)</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>&lt; 125</td>
                      <td>694</td>
                      <td>4.7%</td>
                    </tr>
                    <tr class="italic">
                      <td>125 - 139</td>
                      <td>5,750</td>
                      <td>39.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>140 - 154</td>
                      <td>6,469</td>
                      <td>44.1%</td>
                    </tr>
                    <tr class="italic">
                      <td>155 - 169</td>
                      <td>1,649</td>
                      <td>11.3%</td>
                    </tr>
                    <tr class="italic">
                      <td>&gt; 170</td>
                      <td>93</td>
                      <td>0.6%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Transfused RBC units</td>
                      <td>14,655</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>RBC Storage Time (days)</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>&lt; 10 days</td>
                      <td>2,601</td>
                      <td>17.7%</td>
                    </tr>
                    <tr class="italic">
                      <td>10-19 days</td>
                      <td>7,523</td>
                      <td>51.3%</td>
                    </tr>
                    <tr class="italic">
                      <td>20-29 days</td>
                      <td>3,259</td>
                      <td>22.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>30-39 days</td>
                      <td>1,096</td>
                      <td>7.5%</td>
                    </tr>
                    <tr class="italic">
                      <td>&gt; 40 days</td>
                      <td>176</td>
                      <td>1.2%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Transfused RBC units</td>
                      <td>14,655</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Donor Sex</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>Male</td>
                      <td>7,996</td>
                      <td>54.6%</td>
                    </tr>
                    <tr class="italic">
                      <td>Female</td>
                      <td>6,659</td>
                      <td>45.4%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Transfused RBC units</td>
                      <td>14,655</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Donor Parity</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>Nulliparous</td>
                      <td>10,533</td>
                      <td>71.9%</td>
                    </tr>
                    <tr class="italic">
                      <td>Parous</td>
                      <td>4,122</td>
                      <td>28.1%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Transfused RBC units</td>
                      <td>14,655</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>

                <table class="stats-table">
                  <thead>
                    <tr>
                      <th>Weekday of donation</th>
                      <th>Frequency</th>
                      <th>Relative Frequency</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="italic">
                      <td>Monday</td>
                      <td>3,105</td>
                      <td>21.2%</td>
                    </tr>
                    <tr class="italic">
                      <td>Tuesday</td>
                      <td>3,229</td>
                      <td>22.0%</td>
                    </tr>
                    <tr class="italic">
                      <td>Wednesday</td>
                      <td>3,775</td>
                      <td>25.8%</td>
                    </tr>
                    <tr class="italic">
                      <td>Thursday</td>
                      <td>2,716</td>
                      <td>18.5%</td>
                    </tr>
                    <tr class="italic">
                      <td>Friday</td>
                      <td>1,117</td>
                      <td>7.6%</td>
                    </tr>
                    <tr class="italic">
                      <td>Saturday</td>
                      <td>712</td>
                      <td>4.9%</td>
                    </tr>
                    <tr class="italic">
                      <td>Sunday</td>
                      <td>1</td>
                      <td>0.0%</td>
                    </tr>
                    <tr class="total-row">
                      <td>Transfused RBC units</td>
                      <td>14,655</td>
                      <td>100.0%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
      
      // Create UI elements
      createUI() {
        // Create header
        const header = document.createElement('div');
        header.className = 'header';
        header.innerHTML = `
          <h1>Transfusion Data Visualization Dashboard</h1>
          <p>Displaying time-series data after blood transfusion</p>
        `;
        this.container.appendChild(header);
        
        // Create tab navigation
        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'tabs';
        tabsContainer.innerHTML = `
          <button class="tab-button" onclick="openTab(event, 'descriptive-stats-tab')">Descriptive Statistics</button>
          <button class="tab-button active" onclick="openTab(event, 'visualization-tab')">Visualization</button>
        `;
        this.container.appendChild(tabsContainer);
        
        // Create tab content containers
        const descriptiveStatsTab = document.createElement('div');
        descriptiveStatsTab.id = 'descriptive-stats-tab';
        descriptiveStatsTab.className = 'tab-content';
        descriptiveStatsTab.innerHTML = this.createDescriptiveStatsContent();
        this.container.appendChild(descriptiveStatsTab);
        
        const visualizationTab = document.createElement('div');
        visualizationTab.id = 'visualization-tab';
        visualizationTab.className = 'tab-content active';
        this.container.appendChild(visualizationTab);
        
        // Create controls (now inside visualization tab)
        const controls = document.createElement('div');
        controls.className = 'card controls';
        controls.innerHTML = `
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label class="form-label">Vital Parameter:</label>
                <select id="vital-select" class="form-select"></select>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label class="form-label">RBC Component Factor:</label>
                <select id="factor-select" class="form-select"></select>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Time Range (minutes):</label>
            <div style="display: flex; align-items: center; gap: 10px;">
          <!-- Time range starts at transfusion time -->
          <input type="number" id="time-min" class="form-input" style="width: 80px;" value="0">
              <span>to</span>
              <input type="number" id="time-max" class="form-input" style="width: 80px;" value="720">
              <button id="time-reset" class="btn btn-sm">Reset</button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Display Options:</label>
            <div style="display: flex; gap: 20px;">
              <label>
              <input type="checkbox" id="show-ci" checked> Show Confidence Interval
              </label>
              <label>
                <input type="checkbox" id="show-base"> Show Base Model
              </label>
              <label>
              <input type="checkbox" id="show-delta" checked> Show Change from Baseline
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Comparison Values:</label>
            <div id="comparison-tags"></div>
          </div>
          
          <div id="debug-container" style="display: none;">
            <div class="form-group">
              <label>
                <input type="checkbox" id="debug-mode"> Enable Debug Mode
              </label>
            </div>
            <div id="debug-output" class="debug-info" style="display: none;"></div>
          </div>
        `;
        visualizationTab.appendChild(controls);
        
        // Create chart area
        const chartCard = document.createElement('div');
        chartCard.className = 'card';
        chartCard.innerHTML = `
          <div id="chart-title" class="header" style="margin-bottom: 10px;"></div>
          <div id="model-descriptions" class="info" style="margin-bottom: 10px;"></div>
          <div id="chart-container" class="chart-container">
            <canvas id="chart-canvas"></canvas>
          </div>
        `;
        visualizationTab.appendChild(chartCard);
        
        // Info card for Vital Parameters and RBC factors
        const infoCard = document.createElement('div');
        infoCard.className = 'card';
        infoCard.innerHTML = `
          <p>This dashboard visualizes the time series of vital parameters after blood transfusion, showing how different donor and blood component factors affect vital parameter trajectories in ICU patients.</p>
          <div class="row">
            <div class="col">
              <p><strong>Vital Parameters:</strong></p>
              <ul>
                <li>Mean Arterial Pressure (mmHg)</li>
                <li>Systolic Blood Pressure (mmHg)</li>
                <li>Diastolic Blood Pressure (mmHg)</li>
                <li>Heart Rate (bpm)</li>
                <li>Fraction of Inspired Oxygen (%)</li>
                <li>Peripheral Capillary Oxygen Saturation (%)</li>
                <li>Minute Ventilation (L/min)</li>
              </ul>
            </div>
            <div class="col">
              <p><strong>RBC Component Factors:</strong></p>
              <ul>
                <li>Donor Hemoglobin (g/L)</li>
                <li>Donor Parity (parous or nulliparous)</li>
                <li>Donor Sex (male or female)</li>
                <li>RBC Component Storage Time (days)</li>
                <li>Weekday of Donation</li>
              </ul>
            </div>
          </div>
        `;
        visualizationTab.appendChild(infoCard);
        
        // Event listeners
        document.getElementById('vital-select').addEventListener('change', (e) => {
          this.selectedVital = e.target.value;
          this.updateCompFactors();
        });
        
        document.getElementById('factor-select').addEventListener('change', (e) => {
          this.selectedCompFactor = e.target.value;
          this.loadVisualizationData();
        });
        
        document.getElementById('time-min').addEventListener('change', (e) => {
          this.timeRange[0] = parseInt(e.target.value);
          this.updateChart();
        });
        
        document.getElementById('time-max').addEventListener('change', (e) => {
          this.timeRange[1] = parseInt(e.target.value);
          this.updateChart();
        });
        
        document.getElementById('time-reset').addEventListener('click', () => {
          this.timeRange = [0, 720];
          document.getElementById('time-min').value = 0;
          document.getElementById('time-max').value = 720;
          this.updateChart();
        });
        
        document.getElementById('show-ci').addEventListener('change', (e) => {
          this.showConfidenceInterval = e.target.checked;
          this.updateChart();
        });
        
        document.getElementById('show-base').addEventListener('change', (e) => {
          this.showBaseModel = e.target.checked;
          this.updateChart();
        });
        
        document.getElementById('show-delta').addEventListener('change', (e) => {
          this.showDeltaPlot = e.target.checked;
          this.updateChart();
        });
        
        // Debug mode
        document.getElementById('debug-mode').addEventListener('change', (e) => {
          this.debugMode = e.target.checked;
          document.getElementById('debug-output').style.display = this.debugMode ? 'block' : 'none';
          if (this.debugMode) {
            this.logDebug('Debug mode enabled');
          }
        });
        
        // Check URL for debug flag
        if (window.location.search.includes('debug=true')) {
          document.getElementById('debug-container').style.display = 'block';
          document.getElementById('debug-mode').checked = true;
          this.debugMode = true;
          document.getElementById('debug-output').style.display = 'block';
          this.logDebug('Debug mode enabled via URL parameter');
        }
        
        // Reflect initial state
        document.getElementById('show-ci').checked = true;
        document.getElementById('show-base').checked = false;
        document.getElementById('show-delta').checked = true;
      }
      
      // Load index data
      async loadIndexData() {
        try {
          this.showLoading();
          this.logDebug("Attempting to load index data...");
          
          const indexFileOptions = [
            { case: 'lowercase', path: './data/viz_index.csv' },
            { case: 'uppercase', path: './data/VIZ_INDEX.CSV' }
          ];
          
          let csvText = null;
          
          for (const option of indexFileOptions) {
            try {
              this.logDebug(`Trying ${option.case} index file: ${option.path}`);
              const response = await fetch(option.path);
              
              if (response.ok) {
                csvText = await response.text();
                this.fileCase = option.case;
                this.logDebug(`Successfully loaded ${option.case} index file`);
                break;
              } else {
                this.logDebug(`${option.case} index file returned status: ${response.status}`);
              }
            } catch (err) {
              this.logDebug(`Error loading ${option.case} index file: ${err.message}`);
            }
          }
          
          if (!csvText) {
            throw new Error("Could not load index file in either uppercase or lowercase format");
          }
          
          this.logDebug("Parsing index CSV...");
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              if (results.errors && results.errors.length > 0) {
                this.logDebug(`CSV parse errors: ${JSON.stringify(results.errors)}`);
              }
              
              this.logDebug(`CSV parsed successfully, found ${results.data.length} rows`);
              
              this.indexData = results.data.map(row => {
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                  cleanRow[key] = typeof row[key] === 'string' ? row[key].trim() : row[key];
                });
                return cleanRow;
              });
              
              // Gather unique vital parameters
              let unsortedVitals = _.uniqBy(this.indexData, 'VitalParam')
                .map(item => ({
                  value: item.VitalParam,
                  label: item.VitalName 
                    ? item.VitalName.replace('Vital Parameter Trajectory: ', '') 
                    : item.VitalParam
                }));
              
              // 1) We reorder them to the user-requested sequence
              const desiredOrder = [
                'Mean Arterial Pressure (mmHg)',
                'Systolic Blood Pressure (mmHg)',
                'Diastolic Blood Pressure (mmHg)',
                'Heart Rate (bpm)',
                'Fraction of Inspired Oxygen (%)',
                'Peripheral Capillary Oxygen Saturation (%)',
                'Minute Ventilation (L/min)'
              ];
              
              // Sort vitals by that custom order
              this.vitalParams = unsortedVitals.sort((a, b) => {
                const i1 = desiredOrder.indexOf(a.label);
                const i2 = desiredOrder.indexOf(b.label);
                
                // If both are found, compare indexes
                if (i1 !== -1 && i2 !== -1) {
                  return i1 - i2;
                }
                // If one is missing from desired list, push it after the known ones
                if (i1 === -1 && i2 === -1) {
                  // fallback: normal alphabetical
                  return a.label.localeCompare(b.label);
                } else if (i1 === -1) {
                  return 1;
                } else if (i2 === -1) {
                  return -1;
                }
                return 0; 
              });
              
              this.logDebug(`Reordered vitalParams: ${this.vitalParams.map(v => v.label).join(', ')}`);
              
              // Default vital param: "Mean Arterial Pressure (mmHg)" if it exists
              const desiredVital = this.vitalParams.find(v => v.label === 'Mean Arterial Pressure (mmHg)');
              if (desiredVital) {
                this.selectedVital = desiredVital.value;
              } else if (this.vitalParams.length > 0) {
                this.selectedVital = this.vitalParams[0].value;
              } else {
                this.logDebug("No vital parameters found in index data after reorder");
                this.showError("No vital parameters found in index data. Check CSV format.");
                this.hideLoading();
                return;
              }
              
              this.logDebug(`Selected initial vital parameter: ${this.selectedVital}`);
              
              // Populate dropdown, then factor
              this.updateVitalSelect();
              this.updateCompFactors();
              
              this.hideLoading();
            },
            error: (error) => {
              this.logDebug(`CSV parse error: ${error.message}`);
              throw new Error(`CSV parse error: ${error.message}`);
            }
          });
        } catch (error) {
          this.logDebug(`Failed to load index data: ${error.message}`);
          this.hideLoading();
          this.showError(`Failed to load index data: ${error.message}`);
        }
      }
      
      // Update RBC component factors
      updateCompFactors() {
        if (!this.selectedVital || this.indexData.length === 0) return;
        
        const relevantFactors = this.indexData.filter(item => item.VitalParam === this.selectedVital);
        this.logDebug(`Found ${relevantFactors.length} comparison factors for vital ${this.selectedVital}`);
        
        this.compFactors = relevantFactors.map(item => ({
          value: item.CompFactor,
          label: item.CompName || item.CompFactor
        }));
        
        // Update the RBC factor dropdown
        this.updateCompFactorSelect();
        
        // Check if the user's current RBC factor is still valid
        const isUserFactorValid = this.compFactors.some(f => f.value === this.selectedCompFactor);
        
        // If it's not valid, pick "Donor Hemoglobin" if it exists, otherwise first factor
        if (!isUserFactorValid) {
          const donorHb = this.compFactors.find(f => f.label === 'Donor Hemoglobin');
          if (donorHb) {
            this.selectedCompFactor = donorHb.value;
          } else if (this.compFactors.length > 0) {
            this.selectedCompFactor = this.compFactors[0].value;
          } else {
            this.logDebug("No comparison factors found for selected vital parameter");
            this.showError(`No comparison factors found for ${this.selectedVital}`);
            return;
          }
        }
        
        this.logDebug(`Final RBC factor selection: ${this.selectedCompFactor}`);
        
        // Make sure the dropdown reflects the final selection
        const select = document.getElementById('factor-select');
        if (select) {
          select.value = this.selectedCompFactor;
        }
        
        // Load new data with the final factor
        this.loadVisualizationData();
      }
      
      // Populate Vital Parameter dropdown
      updateVitalSelect() {
        const select = document.getElementById('vital-select');
        select.innerHTML = '';
        
        this.vitalParams.forEach(vital => {
          const option = document.createElement('option');
          option.value = vital.value;
          option.textContent = vital.label;
          select.appendChild(option);
        });
        
        select.value = this.selectedVital;
      }
      
      // Populate RBC factor dropdown
      updateCompFactorSelect() {
        const select = document.getElementById('factor-select');
        select.innerHTML = '';
        
        this.compFactors.forEach(factor => {
          const option = document.createElement('option');
          option.value = factor.value;
          option.textContent = factor.label;
          select.appendChild(option);
        });
      }
      
      // Safe fetch
      async safeFetch(baseName) {
        const fileOptions = [];
        
        if (this.fileCase === 'uppercase') {
          fileOptions.push(`./data/${baseName.toUpperCase()}.CSV`);
          fileOptions.push(`./data/${baseName.toUpperCase()}.csv`);
        } else {
          fileOptions.push(`./data/${baseName}.csv`);
          fileOptions.push(`./data/${baseName}.CSV`);
        }
        
        // Also always try both cases
        fileOptions.push(`./data/${baseName.toUpperCase()}.CSV`);
        fileOptions.push(`./data/${baseName}.csv`);
        
        this.logDebug(`Attempting to fetch file with base name: ${baseName}`);
        this.logDebug(`Will try paths: ${fileOptions.join(', ')}`);
        
        let lastError = null;
        for (const path of fileOptions) {
          try {
            this.logDebug(`Trying path: ${path}`);
            const response = await fetch(path);
            if (response.ok) {
              this.logDebug(`Successfully loaded file from: ${path}`);
              return { 
                text: await response.text(),
                path: path
              };
            } else {
              this.logDebug(`Path ${path} returned status: ${response.status}`);
              lastError = new Error(`HTTP status ${response.status} for ${path}`);
            }
          } catch (err) {
            this.logDebug(`Error fetching ${path}: ${err.message}`);
            lastError = err;
          }
        }
        
        throw lastError || new Error("Failed to load file with all attempted paths");
      }
      
      // Load the data for the current Vital + RBC factor combination
      async loadVisualizationData() {
        if (!this.selectedVital || !this.selectedCompFactor) return;
        
        try {
          this.showLoading();
          
          const oldFactor = this.lastSelectedCompFactor;
          const oldVital = this.lastSelectedVital;
          const factorChanged = (oldFactor !== null && oldFactor !== this.selectedCompFactor);
          const vitalChanged = (oldVital !== null && oldVital !== this.selectedVital);
          
          // Update stored values
          this.lastSelectedCompFactor = this.selectedCompFactor;
          this.lastSelectedVital = this.selectedVital;

          const baseFileName = `VIZ_${this.selectedVital.trim().toUpperCase()}_${this.selectedCompFactor.trim().toUpperCase()}`;
          this.logDebug(`Base visualization filename: ${baseFileName}`);
          
          const { text: csvText, path: loadedPath } = await this.safeFetch(baseFileName);
          this.currentFileName = loadedPath.split('/').pop();
          this.logDebug(`Using file: ${this.currentFileName}`);
          
          this.logDebug("Parsing visualization CSV...");
          Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: (results) => {
              if (results.errors && results.errors.length > 0) {
                this.logDebug(`CSV parse errors: ${JSON.stringify(results.errors)}`);
              }
              
              if (results.data.length === 0) {
                throw new Error("No data found in the CSV file");
              }
              
              this.logDebug(`Parsed ${results.data.length} rows of visualization data`);
              
              const firstRow = results.data[0];
              this.metaInfo = {
                vitalName: firstRow.VitalName || "Vital Parameter",
                compName: firstRow.CompName || "Comparison Factor",
                yLabel: firstRow.YLabel || "Value",
                DeltaYLabel: firstRow.DeltaYLabel || "Change in Value"
              };
              
              this.logDebug(`Metadata: ${JSON.stringify(this.metaInfo)}`);
              
              // Chart title
              document.getElementById('chart-title').innerHTML = `
                <h2>${this.showDeltaPlot ? 'Change in ' : ''}${this.metaInfo.vitalName} by ${this.metaInfo.compName}</h2>
              `;
              
              // Model descriptions
              document.getElementById('model-descriptions').innerHTML = `
                <div style="display: flex; justify-content: center; gap: 20px;">
                  <div style="padding: 5px 10px; border-left: 4px solid #3b82f6;">
                    <span style="font-weight: bold;">Base Model:</span> Base Model: A mixed-effects model with a random intercept for patient ID that adjusts for time from transfusion (natural cubic spline with fixed knots at -660, -360, -60, 0, 60, 360, and 660 minutes), patient age and time spent in the ICU prior to transfusion (natural cubic splines with three percentile-based knots), RBC transfusion count, patient sex, and ICU ward name
                  </div>
                  <div style="padding: 5px 10px; border-left: 4px solid #3b82f6;">
                    <span style="font-weight: bold;">Fully Adjusted Model:</span> A mixed-effects model containing all base model variables as well as cumulative crystalloid fluids and vasopressors administered (in ml) in the last 1 and 24 hours prior to transfusion (natural cubic splines with three percentile-based knots), and a binary variable for whether sedatives were administered in the last 1 and 24 hours prior to transfusion 
                  </div>
                </div>
              `;
              
              // Identify the comparison column
              const sampleRow = results.data[0];
              const comparisonColumnName = Object.keys(sampleRow).find(key => 
                key !== 'TimeFromTransfusion' && 
                key !== 'PredVal_Base' && 
                key !== 'StdErrVal_Base' && 
                key !== 'PredVal_Full' && 
                key !== 'StdErrVal_Full' && 
                key !== 'Lower_Full' && 
                key !== 'Upper_Full' && 
                key !== 'VitalParam' && 
                key !== 'CompFactor' && 
                key !== 'CompName' && 
                key !== 'VitalName' && 
                key !== 'YLabel' &&
                key !== 'DeltaYLabel' &&
                key !== 'Delta_Base' &&
                key !== 'Delta_Full' &&
                key !== 'Delta_Lower' &&
                key !== 'Delta_Upper'
              );
              
              if (!comparisonColumnName) {
                this.logDebug(`Could not determine comparison column. Available columns: ${Object.keys(sampleRow).join(', ')}`);
                throw new Error("Could not determine comparison column");
              }
              
              this.logDebug(`Determined comparison column: ${comparisonColumnName}`);
              
              // Keep track of the old selectedComparisons
              const oldSelection = [...this.selectedComparisons];
              
              // All unique categories
              let newValues = _.uniqBy(results.data, comparisonColumnName)
                .map(row => row[comparisonColumnName])
                .filter(value => value !== undefined)
                .sort((a, b) => {
                  if (a === null) return -1;
                  if (b === null) return 1;
                  return a - b;
                });
              
              const hasNull = results.data.some(row => row[comparisonColumnName] === null);
              if (hasNull && newValues[0] !== null) {
                newValues.unshift(null);
              }
              
              this.comparisonValues = newValues;
              this.logDebug(`comparisonValues => ${this.comparisonValues.join(', ')}`);
              
              // Decide how to set selectedComparisons
              if (this.isInitialLoad) {
                this.logDebug("Initial load => show all categories except null");
                this.selectedComparisons = this.comparisonValues.filter(v => v !== null);
                this.isInitialLoad = false;
              } else if (factorChanged) {
                this.logDebug("RBC factor changed => show all categories except null");
                this.selectedComparisons = this.comparisonValues.filter(v => v !== null);
              } else {
                // Vital changed or user reloaded same combos => preserve old selection if valid
                this.logDebug("Vital changed => keep old selection intersection if valid");
                this.selectedComparisons = oldSelection.filter(v => this.comparisonValues.includes(v));
              }
              
              this.logDebug(`Final selectedComparisons => ${this.selectedComparisons.join(', ')}`);
              
              // Store chart data
              this.chartData = {
                data: results.data,
                comparisonColumn: comparisonColumnName
              };
              
              // Update tags
              this.updateComparisonTags(comparisonColumnName);
              
              // Time range inputs
              document.getElementById('time-min').value = this.timeRange[0];
              document.getElementById('time-max').value = this.timeRange[1];
              
              // Render
              this.updateChart();
              
              this.hideLoading();
            },
            error: (error) => {
              this.logDebug(`CSV parse error: ${error.message}`);
              throw new Error(`CSV parse error: ${error.message}`);
            }
          });
        } catch (error) {
          this.logDebug(`Failed to load visualization data: ${error.message}`);
          this.hideLoading();
          this.showError(`Failed to load visualization data: ${error.message}`);
        }
      }
      
      // Create clickable tags
      updateComparisonTags(comparisonColumnName) {
        const container = document.getElementById('comparison-tags');
        container.innerHTML = '';
        
        this.comparisonValues.forEach(value => {
          const tag = document.createElement('span');
          tag.className = this.selectedComparisons.includes(value) ? 'tag active' : 'tag';
          tag.textContent = this.getLegendLabel(value);
          
          tag.addEventListener('click', () => {
            if (this.selectedComparisons.includes(value)) {
              this.selectedComparisons = this.selectedComparisons.filter(v => v !== value);
            } else {
              this.selectedComparisons.push(value);
            }
            tag.className = this.selectedComparisons.includes(value) ? 'tag active' : 'tag';
            this.updateChart();
          });
          
          container.appendChild(tag);
        });
      }
      
      // Human-readable label
      getLegendLabel(value, modelType = null) {
        if (value === null) return 'Reference';
        
        const factor = this.selectedCompFactor.trim();
        let categoryLabel = '';
        
        switch (factor) {
          case 'DonorHb_Cat':
            switch (value) {
              case 1: categoryLabel = 'Donor Hb < 125 g/L'; break;
              case 2: categoryLabel = 'Donor Hb 125-139 g/L'; break;
              case 3: categoryLabel = 'Donor Hb 140-154 g/L'; break;
              case 4: categoryLabel = 'Donor Hb 155-169 g/L'; break;
              case 5: categoryLabel = 'Donor Hb ≥ 170 g/L'; break;
              default: categoryLabel = `Donor Hb Category ${value}`;
            }
            break;
          case 'Storage_Cat':
            switch (value) {
              case 1: categoryLabel = 'Storage < 10 days'; break;
              case 2: categoryLabel = 'Storage 10-19 days'; break;
              case 3: categoryLabel = 'Storage 20-29 days'; break;
              case 4: categoryLabel = 'Storage 30-39 days'; break;
              case 5: categoryLabel = 'Storage ≥ 40 days'; break;
              default: categoryLabel = `Storage Category ${value}`;
            }
            break;
          case 'DonorSex':
            categoryLabel = value === 1 ? 'Male Donor' : value === 2 ? 'Female Donor' : `Donor Sex ${value}`;
            break;
          case 'DonorParity':
            categoryLabel = value === 0 ? 'Nulliparous Donor' : value === 1 ? 'Parous Donor' : `Donor Parity ${value}`;
            break;
          case 'wdy_donation':
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            categoryLabel = days[value-1] || `Day ${value}`;
            break;
          default:
            categoryLabel = `${value}`;
        }
        
        return modelType ? `${categoryLabel} (${modelType})` : categoryLabel;
      }
      
      // Coloring
      getLineColor(value, index = 0) {
        const colors = [
          {line: 'rgb(31, 119, 180)', area: 'rgba(31, 119, 180, 0.2)'},
          {line: 'rgb(255, 127, 14)', area: 'rgba(255, 127, 14, 0.2)'},
          {line: 'rgb(44, 160, 44)', area: 'rgba(44, 160, 44, 0.2)'},
          {line: 'rgb(214, 39, 40)', area: 'rgba(214, 39, 40, 0.2)'},
          {line: 'rgb(148, 103, 189)', area: 'rgba(148, 103, 189, 0.2)'},
          {line: 'rgb(140, 86, 75)', area: 'rgba(140, 86, 75, 0.2)'},
          {line: 'rgb(227, 119, 194)', area: 'rgba(227, 119, 194, 0.2)'}
        ];
        
        if (value === null) {
          return {line: 'rgb(0, 0, 0)', area: 'rgba(0, 0, 0, 0.1)'};
        }
        
        const valueIndex = this.comparisonValues.indexOf(value);
        if (valueIndex === -1) {
          return colors[index % colors.length];
        }
        
        return colors[valueIndex % colors.length];
      }
      
      prepareChartData() {
        if (!this.chartData.data || this.chartData.data.length === 0) return null;
        
        const compColumn = this.chartData.comparisonColumn;
        
        // Filter data by time range and selected comparison values
        const filteredData = this.chartData.data.filter(row => 
          row.TimeFromTransfusion >= this.timeRange[0] && 
          row.TimeFromTransfusion <= this.timeRange[1]
        );
        
        if (filteredData.length === 0) return null;
        
        // Group by comparison column value
        const groupedByComp = _.groupBy(filteredData, row => {
          const categoryValue = row[compColumn];
          if (categoryValue === null || categoryValue === undefined || categoryValue === '') {
            return 'null';
          }
          return categoryValue;
        });
        
        const datasets = [];
        const allTimes = [];
        const processedCategories = new Set();
        
        // For absolute vs. delta mode
        const valueField = this.showDeltaPlot ? 'Delta_Full' : 'PredVal_Full';
        const lowerField = this.showDeltaPlot ? 'Delta_Lower' : 'Lower_Full';
        const upperField = this.showDeltaPlot ? 'Delta_Upper' : 'Upper_Full';
        const baseField = this.showDeltaPlot ? 'Delta_Base' : 'PredVal_Base';
        
        // Process each comparison value category
        Object.entries(groupedByComp).forEach(([compValue, rows], index) => {
          const categoryValue = compValue === "null" ? null : 
                                isNaN(parseFloat(compValue)) ? compValue : parseFloat(compValue);
          
          // Skip if not selected
          if (!this.selectedComparisons.includes(categoryValue)) {
            return;
          }
          processedCategories.add(String(categoryValue));
          
          // Sort rows by time
          const sortedRows = _.sortBy(rows, 'TimeFromTransfusion');
          
          // Collect all time points for x-axis
          sortedRows.forEach(row => {
            if (!allTimes.includes(row.TimeFromTransfusion)) {
              allTimes.push(row.TimeFromTransfusion);
            }
          });
          
          const color = this.getLineColor(categoryValue, index);
          const categoryLabel = this.getLegendLabel(categoryValue);
          
          // Check for main line data
          const hasValidMainData = sortedRows.some(row => 
            row[valueField] !== null && row[valueField] !== undefined
          );
          
          // Check for CI data
          const hasValidCIData = sortedRows.some(row => 
            row[lowerField] !== null && row[lowerField] !== undefined &&
            row[upperField] !== null && row[upperField] !== undefined
          );
          
          // Build the CI dataset(s) if user wants it and data is valid
          if (hasValidMainData) {
            if (this.showConfidenceInterval && hasValidCIData) {
              // The “lower boundary” dataset (no fill)
              const lowerCIDataset = {
                label: `${categoryLabel} (CI Lower)`,
                data: sortedRows.map(row => ({
                  x: row.TimeFromTransfusion,
                  y: row[lowerField]
                })),
                borderColor: 'transparent',
                backgroundColor: 'transparent',
                pointRadius: 0,
                fill: false,
                tension: 0.3
              };
              
              // The “upper boundary” dataset (fill down to the lower)
              const upperCIDataset = {
                label: `${categoryLabel} (CI Upper)`,
                data: sortedRows.map(row => ({
                  x: row.TimeFromTransfusion,
                  y: row[upperField]
                })),
                borderColor: 'transparent',
                backgroundColor: color.area,
                pointRadius: 0,
                fill: '-1', // fill to the previous dataset
                tension: 0.3
              };
              
              // Then the main “Full” line itself
              const mainLineDataset = {
                label: `${categoryLabel} (Full)`,
                data: sortedRows.map(row => ({
                  x: row.TimeFromTransfusion,
                  y: row[valueField]
                })),
                borderColor: color.line,
                backgroundColor: color.line,
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                pointRadius: 0
              };
              
              // Push in the correct order to create a band
              datasets.push(lowerCIDataset);
              datasets.push(upperCIDataset);
              datasets.push(mainLineDataset);
              
            } else {
              // If no CI or invalid CI, just push the main line
              datasets.push({
                label: `${categoryLabel} (Full)`,
                data: sortedRows.map(row => ({
                  x: row.TimeFromTransfusion,
                  y: row[valueField]
                })),
                borderColor: color.line,
                backgroundColor: color.line,
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                pointRadius: 0
              });
            }
          }
          
          // Base model line
          const hasValidBaseData = sortedRows.some(row => 
            row[baseField] !== null && row[baseField] !== undefined
          );
          
          if (this.showBaseModel && hasValidBaseData) {
            datasets.push({
              label: `${categoryLabel} (Base)`,
              data: sortedRows.map(row => ({
                x: row.TimeFromTransfusion,
                y: row[baseField]
              })),
              borderColor: color.line,
              backgroundColor: color.line,
              borderWidth: 1.5,
              borderDash: [5, 5],
              tension: 0.3,
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 2
            });
          }
        });
        
        if (processedCategories.size === 0) {
          return null;
        }
        
        // Sort time points for consistent x-axis
        allTimes.sort((a, b) => a - b);
        
        return {
          datasets: datasets,
          allTimes: allTimes
        };
      }
      
      updateChart() {
        const chartData = this.prepareChartData();
        
        if (!chartData) {
          this.clearChart();
          return;
        }
        
        const ctx = document.getElementById('chart-canvas').getContext('2d');
        
        // Find min and max values including confidence intervals
        let minY = Infinity;
        let maxY = -Infinity;
        let minLineY = Infinity;
        let maxLineY = -Infinity;
        
        // First pass: scan all datasets for extreme values
        chartData.datasets.forEach(dataset => {
          // Check if this is a CI dataset by looking at label
          const isCI = dataset.label && (
            dataset.label.includes('CI Lower') || 
            dataset.label.includes('CI Upper')
          );
          
          dataset.data.forEach(point => {
            if (point.y !== null && !isNaN(point.y)) {
              // Track both CI bounds and line data separately
              if (isCI) {
                minY = Math.min(minY, point.y);
                maxY = Math.max(maxY, point.y);
              } else {
                minY = Math.min(minY, point.y);
                maxY = Math.max(maxY, point.y);
                minLineY = Math.min(minLineY, point.y);
                maxLineY = Math.max(maxLineY, point.y);
              }
            }
          });
        });
        
        // Calculate range of actual data points
        const dataRange = maxY - minY;
        const lineRange = maxLineY - minLineY;
        
        // Enhanced padding calculation to ensure plots are centered
        // Use at least 30% padding (15% on each side) or more if needed
        const paddingFactor = Math.max(0.30, 
                                      // Increase padding if CI bands are much wider than lines
                                      dataRange > 2 * lineRange ? 0.40 : 0.30);
        
        const padding = dataRange * paddingFactor;
        const paddingTop = padding / 2;
        const paddingBottom = padding / 2;
        
        // Calculate initial bounds with padding
        let yMin = minY - paddingBottom;
        let yMax = maxY + paddingTop;
        
        // If we're in absolute mode, clamp below 0
        if (!this.showDeltaPlot) {
          yMin = Math.max(0, yMin);
          
          // Special case for SpO2 in absolute mode
          if (this.selectedVital && this.selectedVital.trim() === 'SpO2' && yMax > 99) {
            yMax = 100;
          }
        } else {
          // Delta mode - ensure zero is included and centered when appropriate
          if (minY > 0 && maxY > 0) {
            // All values positive
            yMin = -dataRange * 0.15; // Show a bit below zero
          } else if (minY < 0 && maxY < 0) {
            // All values negative
            yMax = dataRange * 0.15; // Show a bit above zero
          } else {
            // Mixed positive and negative
            // Ensure we have symmetric padding around zero if data is approximately symmetric
            const absMax = Math.max(Math.abs(minY), Math.abs(maxY));
            if (Math.abs(Math.abs(maxY) - Math.abs(minY)) < dataRange * 0.3) {
              // Fairly symmetric data
              yMin = -absMax * 1.15;
              yMax = absMax * 1.15;
            }
          }
        }
        
        // Ensure minimum range to prevent cramped axis
        if (yMax - yMin < 5) {
          const center = (yMax + yMin) / 2;
          yMin = center - 2.5;
          yMax = center + 2.5;
          
          // In absolute mode, maintain zero as lower bound
          if (!this.showDeltaPlot) {
            yMin = Math.max(0, yMin);
          }
        }
        
        // Update chart title
        document.getElementById('chart-title').innerHTML = `
          <h2>${this.showDeltaPlot ? 'Change in ' : ''}${this.metaInfo.vitalName} by ${this.metaInfo.compName}</h2>
        `;
        
        if (this.chart) {
          this.chart.destroy();
        }
        
        this.chart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: chartData.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'nearest',
              intersect: false
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Time From Transfusion (minutes)'
                },
                min: this.timeRange[0],
                max: this.timeRange[1]
              },
              y: {
                title: {
                  display: true,
                  text: this.showDeltaPlot ? this.metaInfo.DeltaYLabel : this.metaInfo.yLabel
                },
                min: minY,
                max: maxY,
                ticks: {
                  // Prevent duplicate labels and ensure integers for cleaner display
                  callback: (value, index, values) => {
                    // Convert to integer for cleaner display
                    const intValue = parseInt(value);
                    
                    // Prevent duplicate labels by checking if this value
                    // is very close to the previous or next value
                    if (index > 0 && Math.abs(value - values[index-1].value) < 0.1) {
                      return null; // Skip this label to avoid duplication
                    }
                    
                    // Return integers for all ticks for consistency
                    return intValue;
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  filter: function(legendItem) {
                    // Hide "CI Upper" from legend if desired:
                    return !legendItem.text.includes('CI Upper');
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                  }
                }
              }
            }
          }
        });
      }
      
      clearChart() {
        if (this.chart) {
          this.chart.destroy();
          this.chart = null;
        }
      }
      
      logDebug(message) {
        if (!this.debugMode) return;
        const debugOutput = document.getElementById('debug-output');
        const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
        debugOutput.textContent += `[${timestamp}] ${message}\n`;
        debugOutput.scrollTop = debugOutput.scrollHeight;
        console.log(`[DEBUG] ${message}`);
      }
      
      showLoading() {
        if (!this.loadingElement) {
          this.loadingElement = document.createElement('div');
          this.loadingElement.className = 'loading';
          this.loadingElement.textContent = 'Loading data...';
          this.container.appendChild(this.loadingElement);
        }
      }
      
      hideLoading() {
        if (this.loadingElement) {
          this.loadingElement.remove();
          this.loadingElement = null;
        }
      }
      
      showError(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error';
        errorElement.textContent = message;
        this.container.insertBefore(errorElement, this.container.firstChild);
        
        setTimeout(() => {
          errorElement.remove();
        }, 10000);
      }
    }
    
    // Initialize dashboard when document is ready
    document.addEventListener('DOMContentLoaded', function() {
      new TransfusionDashboard('app-container');
    });
  </script>
</body>
</html>
